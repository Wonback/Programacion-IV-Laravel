<app-navbar></app-navbar>

<section class="neo-page neo-page--with-nav scanner-page">
  <div class="neo-wrapper neo-wrapper--wide">
    <article class="neo-card neo-card--accent scanner-card">
      <header class="neo-card__header">
        <span class="neo-card__eyebrow">Controlá el acceso en tiempo real</span>
        <h1 class="neo-card__title">Validar tickets</h1>
        <p class="neo-card__subtitle">
          Elegí un evento, escaneá el código QR o subí una imagen y asegurate de que cada ticket sea auténtico.
        </p>
      </header>

      <div class="scanner-actions">
        <label class="neo-field">
          <span>Seleccioná un evento</span>
          <div class="neo-field__control">
            <select [(ngModel)]="selectedEventId" (change)="selectEvent()">
              <option [ngValue]="null">Elegí un evento</option>
              <option *ngFor="let e of events" [ngValue]="e.id">{{ e.title }}</option>
            </select>
          </div>
        </label>

        <button type="button" class="neo-button neo-button--ghost" (click)="useFileInput = !useFileInput" [disabled]="!selectedEventId">
          <fa-icon [icon]="faQrcode"></fa-icon>
          {{ useFileInput ? 'Usar cámara' : 'Subir QR desde archivo' }}
        </button>
      </div>

      <div class="scanner-viewport" *ngIf="selectedEventId">
        <div *ngIf="!useFileInput" class="scanner-camera">
          <zxing-scanner (scanSuccess)="onCodeResult($event)" [formats]="formats"></zxing-scanner>
        </div>

        <div *ngIf="useFileInput" class="scanner-upload">
          <label class="neo-upload">
            <input type="file" accept="image/*" (change)="onFileSelected($event)" />
            <fa-icon [icon]="faImage"></fa-icon>
            Seleccionar imagen
          </label>
        </div>
      </div>

      <div class="scanner-result" *ngIf="qrResult || message">
        <div class="neo-feedback neo-feedback--info" *ngIf="qrResult">
          <fa-icon [icon]="faQrcode"></fa-icon>
          <span class="scanner-result__code">{{ qrResult }}</span>
        </div>
        <div
          *ngIf="message"
          class="neo-feedback"
          [ngClass]="{
            'neo-feedback--success': message.includes('válido') || message.includes('exitosamente'),
            'neo-feedback--error': message.includes('inválido') || message.includes('usado')
          }"
        >
          <fa-icon [icon]="faCheck"></fa-icon>
          {{ message }}
        </div>
      </div>

      <div *ngIf="orders.length" class="scanner-table">
        <h2 class="neo-section-title">
          <fa-icon [icon]="faTicketAlt"></fa-icon>
          Tickets escaneados
        </h2>
        <div class="neo-table-container">
          <table class="neo-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>QR</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let o of orders">
                <td>{{ o.id }}</td>
                <td>
                  <div class="scanner-user">
                    <strong>{{ o.user?.name }}</strong>
                    <span>{{ o.user?.email }}</span>
                    <small>ID: {{ o.user?.id }}</small>
                  </div>
                </td>
                <td class="scanner-code">{{ o.qr_code }}</td>
                <td>
                  <span class="neo-badge" [ngClass]="o.used ? 'neo-badge--warning' : 'neo-badge--success'">
                    {{ o.used ? 'Usado' : 'Disponible' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </article>
  </div>
</section>

<app-footer></app-footer>
