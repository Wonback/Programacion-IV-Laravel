<app-navbar></app-navbar>

<section *ngIf="event; else loading" class="neo-page neo-page--with-nav event-detail">
  <div class="neo-wrapper neo-wrapper--wide event-detail__wrapper">
    <div class="event-detail__layout">
      <figure
        class="event-detail__media"
        [class.event-detail__media--empty]="!(imagePreview || event.image_path)"
        [style.background-image]="heroImage()"
      >
        <div class="event-detail__media-overlay"></div>
        <div class="event-detail__media-fallback" *ngIf="!(imagePreview || event.image_path)">
          <fa-icon [icon]="faTicket"></fa-icon>
        </div>
      </figure>

      <article class="neo-card neo-card--accent event-detail__summary">
        <header class="neo-card__header">
          <button class="event-detail__back" type="button" (click)="goHome()">
            <fa-icon [icon]="faArrowLeft"></fa-icon>
            Volver
          </button>
          <span
            class="event-detail__badge"
            *ngIf="event.category"
            [style.border-color]="categoryAccent(event.category)"
            [style.background]="categoryAccentSoft(event.category)"
            [style.color]="categoryAccent(event.category)"
          >
            <fa-icon [icon]="faLayerGroup"></fa-icon>
            {{ categoryLabel(event.category) }}
          </span>
          <h1 class="neo-card__title">{{ event.title }}</h1>
          <p class="neo-card__subtitle" *ngIf="event.description">
            {{ event.description }}
          </p>
        </header>

        <dl class="event-detail__meta">
          <div class="event-detail__meta-item">
            <fa-icon [icon]="faCalendar"></fa-icon>
            <div>
              <dt>Fecha y horario</dt>
              <dd>{{ event.starts_at | date: 'EEEE d MMMM • HH:mm' }}</dd>
            </div>
          </div>
          <div class="event-detail__meta-item">
            <fa-icon [icon]="faUsers"></fa-icon>
            <div>
              <dt>Capacidad</dt>
              <dd>{{ event.capacity }} asistentes</dd>
            </div>
          </div>
          <div class="event-detail__meta-item">
            <fa-icon [icon]="faDollarSign"></fa-icon>
            <div>
              <dt>Valor de la entrada</dt>
              <dd>${{ event.price }}</dd>
            </div>
          </div>
        </dl>

        <div class="event-detail__cta" *ngIf="!editMode">
          <button type="button" class="neo-button neo-button--primary" (click)="goToCheckout(event.id)">
            <fa-icon [icon]="faTicket"></fa-icon>
            Comprar entrada
          </button>
        </div>
      </article>
    </div>

    <article *ngIf="!editMode" class="neo-card event-detail__details">
      <h2>Sobre el evento</h2>
      <p>
        {{ event.description || 'Este evento no tiene una descripción detallada, pero podés consultar con el organizador para más información.' }}
      </p>

      <div class="event-detail__highlights">
        <div class="event-detail__highlight">
          <span>Organizado por</span>
          <strong>#{{ event.user_id }}</strong>
        </div>
        <div class="event-detail__highlight">
          <span>Identificador</span>
          <strong>EVT-{{ event.id }}</strong>
        </div>
        <div class="event-detail__highlight" *ngIf="event.category">
          <span>Categoría</span>
          <strong>{{ categoryLabel(event.category) }}</strong>
        </div>
      </div>
    </article>

    <article *ngIf="editMode" class="neo-card neo-card--inset event-detail__editor">
      <header class="neo-card__header">
        <span class="neo-card__eyebrow">Edición activa</span>
        <h2 class="neo-card__title">Actualizar evento</h2>
        <p class="neo-card__subtitle">
          Ajustá la información y subí una imagen nueva si lo necesitás. Los cambios se verán reflejados de inmediato.
        </p>
      </header>

      <form #editForm="ngForm" (ngSubmit)="saveEdit(editForm)" class="neo-form">
        <div class="neo-form__grid">
          <label class="neo-field neo-field--full">
            <span>Título</span>
            <div class="neo-field__control">
              <input type="text" name="title" [(ngModel)]="formData.title" required placeholder="Nombre del evento" />
            </div>
          </label>

          <label class="neo-field neo-field--full">
            <span>Descripción</span>
            <div class="neo-field__control">
              <textarea
                name="description"
                rows="4"
                [(ngModel)]="formData.description"
                placeholder="Contanos de qué se trata"
              ></textarea>
            </div>
          </label>

          <label class="neo-field">
            <span>Categoría</span>
            <div class="neo-field__control">
              <select name="category" [(ngModel)]="formData.category">
                <option [ngValue]="null">Seleccioná una categoría</option>
                <option *ngFor="let category of categories" [ngValue]="category.value">{{ category.label }}</option>
              </select>
            </div>
          </label>

          <label class="neo-field">
            <span>Capacidad</span>
            <div class="neo-field__control">
              <input type="number" name="capacity" [(ngModel)]="formData.capacity" min="1" required />
            </div>
          </label>

          <label class="neo-field">
            <span>Precio</span>
            <div class="neo-field__control">
              <input type="number" name="price" [(ngModel)]="formData.price" min="0" required />
            </div>
          </label>

          <label class="neo-field neo-field--full">
            <span>Imagen destacada</span>
            <div class="neo-field__control neo-field__control--file">
              <input type="file" (change)="onFileChange($event)" accept="image/*" />
            </div>
            <small *ngIf="imagePreview">Se utilizará la vista previa mostrada en la cabecera.</small>
          </label>
        </div>

        <div class="event-detail__editor-actions">
          <button type="submit" class="neo-button neo-button--primary" [disabled]="uploading">
            <fa-icon [icon]="faPen"></fa-icon>
            {{ uploading ? 'Guardando...' : 'Guardar cambios' }}
          </button>
          <button type="button" class="neo-button neo-button--ghost" (click)="toggleEdit()">
            Cancelar
          </button>
        </div>

        <div *ngIf="errorMessage" class="neo-feedback neo-feedback--error">
          {{ errorMessage }}
        </div>
      </form>
    </article>

    <div class="event-detail__actions" *ngIf="canEdit()">
      <button *ngIf="!editMode" type="button" class="neo-button neo-button--primary" (click)="toggleEdit()">
        <fa-icon [icon]="faPen"></fa-icon>
        Editar evento
      </button>
      <button type="button" class="neo-button neo-button--danger" (click)="deleteEvent()">
        <fa-icon [icon]="faTrash"></fa-icon>
        Cancelar evento
      </button>
    </div>
  </div>
</section>

<ng-template #loading>
  <section class="neo-page neo-page--with-nav event-detail event-detail--loading">
    <div class="neo-wrapper neo-wrapper--medium">
      <article class="neo-card event-detail__loading-card">
        <div class="event-detail__loader"></div>
        <p class="neo-text--muted">Recuperando información del evento...</p>
      </article>
    </div>
  </section>
</ng-template>

<app-footer></app-footer>
